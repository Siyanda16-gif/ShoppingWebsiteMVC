@model IEnumerable<ShoppingWebsiteMVC.Models.Order>

@*@{
    ViewBag.Title = "MyOrders";
    ViewBag.order = "active";
}*@

<style>
    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        transition: 0.3s ease-in-out;
    }

    .card {
        transition: 0.3s ease-in-out;
    }

    .hh {
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        color: white;
    }
</style>
<div style="font-size:20px;color:black;">@Session["Username"]</div>

<h2 @*class="m-3 h2 text-secondary p-2" class="hh"*@ style="color:black;margin-top:20px;margin-bottom:20px;text-align:center;">MyOrders </h2>

@if (Model != null && Model.Any())
{
    foreach (var item in Model)
    {
        var orderStatus = "";
        var timeElapsed = (DateTime.Now - item.TDate).Days;

        if (timeElapsed >= 5)
        {
            orderStatus = "Delivered " + item.Products.ProductName;
        }
        else if (timeElapsed == 0 || timeElapsed == 1)
        {
            orderStatus = "Preparing Order for " + item.Products.ProductName;
        }
        else if (timeElapsed == 3)
        {
            orderStatus = "Ready for Delivery of " + item.Products.ProductName;
        }
        else
        {
            orderStatus = "Waiting";
        }

        <div class="card p-3 m-2">
            <div class="row p-3">
                <div class="col-md-3 col-12 align-content-center text-center">
                    @{ var img = item.ProductId + ".jpg"; }
                    <img src="~/Images/@img" height="120" />
                </div>
                <div class="col-md-6 col-12 text-justify">
                    <div class="col-12">
                        @Html.DisplayFor(modelItem => item.Products.ProductName)
                    </div>
                    <div class="col-12">
                        Quantity: @Html.DisplayFor(modelItem => item.NoofProduct)
                    </div>
                    <div class="col-12 text-muted font-italic small">
                        Seller: @Html.DisplayFor(modelItem => item.Products.Supplier.Name)
                    </div>
                    <div class="col-12 font-weight-bolder d-inline" style="font-size:1.2rem;">
                        R @Html.DisplayFor(modelItem => item.Amount)
                    </div>
                    <div class="text-secondary col-12">
                        Ordered on: @Html.DisplayFor(modelItem => item.TDate)
                    </div>
                    <div class="text-secondary col-12">
                        <span id="orderStatus_@item.Id">@orderStatus</span>
                    </div>
                </div>
                <div class="col-md-3 col-12 align-content-center">
                    @if (DateTime.Now < item.TDate.AddDays(3))
                    {
                        @*@Html.ActionLink("Cancel Order", "CancelOrder", new { id = item.Id }, new { @class = "btn btn-danger btn-sm" })*@
                    }
                    @Html.ActionLink("Give Feedback", "Feedback", new { ProductId = item.ProductId }, new { @class = "btn btn-info btn-sm" })
                    @Html.ActionLink("Continue Shopping", "Index", "Product", null, new { @class = "btn btn-info btn-sm mt-2" })
                    @*<button type="button" class="btn btn-primary btn-sm" onclick="downloadOrderDetailsAsPdf(@item.Id)">Download Order Details as PDF</button>*@
                </div>
              
                    <script>
                        function downloadOrderDetailsAsPdf(orderId) {
                        var url = '/Order/DownloadOrderDetailsAsPdf/' + orderId;
                        var xhr = new XMLHttpRequest();
                        xhr.open('GET', url, true);
                        xhr.responseType = 'blob';
                        xhr.onload = function() {
                            if (xhr.status === 200) {
                                var blob = xhr.response;
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = 'OrderDetails_' + orderId + '.pdf';
                        link.click();
                            }
                        };
                        xhr.send();
                    }
                </script>
                
            </div>
        </div>
    }
}
else
{
    <div class="alert alert-info p-3">
        You haven't ordered anything yet
        <a href="/Product" class="btn btn-success btn-sm">Buy Products</a>
    </div>
}